import subprocess
import os
import datetime
import sys
import threading

R = '\033[31m'  # Red
G = '\033[32m'  # Green
Y = '\033[33m'  # Yellow
B = '\033[34m'  # Blue 
C = '\033[0m'   # Reset

LOG_FILE = "sws_scan_result.log"
KATANA_FILE = "katana_urls.txt"
WAPITI_FILE = "wapiti_report.txt"
ZAP_FILE = "zap_report.html"
XSSTRIKE_PATH = "/home/kali/swit-scanner/apps/XSStrike/xsstrike.py"

def banner():
    os.system('clear')
    print(f"{B}")
    print(r"   ███████╗██╗    ██╗███████╗")
    print(r"   ██╔════╝██║    ██║██╔════╝")
    print(r"   ███████╗██║ █╗ ██║███████╗")
    print(r"   ╚════██║██║███╗██║╚════██║")
    print(r"   ███████║╚███╔███╔╝███████║")
    print(r"   ╚══════╝ ╚══╝╚══╝ ╚══════╝")
    print(f"{Y}")
    print(" ╔" + "═"*60 + "╗")
    print(" ║   LOVE FROM FPT University   ║ ILOVEURWEB Version 1.0")
    print(" ╚" + "═"*60 + "╝" + f"{C}")

def write_log(content):
    with open(LOG_FILE, "a", encoding="utf-8") as f:
        f.write(content + "\n")

def run_command(command, description):
    print(f"{G}[+] Đang thực hiện: {description}...{C}")
    write_log(f"\n--- {description} ({datetime.datetime.now()}) ---")
    try:
        process = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True)
        for line in process.stdout:
            print(line, end='')
            write_log(line.strip())
        process.wait()
    except Exception as e:
        print(f"{R}[!] ERROR: {e}{C}")
# --- CÁC HÀM CÔNG CỤ ---

def nmap_scan(target):
    domain = target.replace("http://", "").replace("https://", "").split('/')[0]
    run_command(f"nmap -sV -T4 {domain}", "Nmap Scanning")

def katana_scan(target):
    run_command(f"katana -u {target} -jc -kf all -o {KATANA_FILE}", "Katana Spidering")

def xsstrike_scan(target):
    if os.path.exists(XSSTRIKE_PATH):
        run_command(f"python3 {XSSTRIKE_PATH} -u \"{target}\" --crawl", "XSStrike Scanning")
    else:
        print(f"{R}[!] Not found XSStrike at {XSSTRIKE_PATH}{C}")

def nikto_scan(target):
    run_command(f"nikto -h {target} -Tuning 123b", "Nikto Scanning")

def wapiti_scan(target):
    run_command(f"wapiti -u {target} -f txt -o {WAPITI_FILE}", "Wapiti Scanning")

def zap_scan(target):
    run_command(f"docker run -v $(pwd):/zap/wrk/:rw -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t {target} -r {ZAP_FILE}", "OWASP ZAP Baseline")

# --- HÀM XEM KẾT QUẢ ---

def view_results():
    while True:
        os.system('clear')
        banner()
        print(f"{Y}--- FILE RESULT ---{C}")
        files = [LOG_FILE, KATANA_FILE, WAPITI_FILE, ZAP_FILE]
        for i, f_name in enumerate(files, 1):
            status = f"{G}[READY]{C}" if os.path.exists(f_name) else f"{R}[Trống]{C}"
            print(f"{i}. {f_name} {status}")
        print("0. Main Menu")
        
        choice = input(f"{Y}\nChoose file: {C}")
        if choice == '0': break
        try:
            target_f = files[int(choice)-1]
            if os.path.exists(target_f):
                if target_f.endswith(".html"):
                    # Mở file HTML bằng trình duyệt mặc định
                    subprocess.run(f"xdg-open {target_f} 2>/dev/null", shell=True)
else:
                    # Mở file text bằng less (nhấn Q để thoát)
                    os.system(f"less -R {target_f}")
            else:
                input(f"{R}File does not exsist. Press Enter...{C}")
        except: pass

# --- MENU CHÍNH ---

def main_menu():
    while True:
        banner()
        print(" 1. Full Audit Scan")
        print(" 2. Nmap Scan")
        print(" 3. URL Scan")
        print(" 4. XSS Scan")
        print(" 5. Server Scan")
        print(" 6. Web Vuln Scan")
        print(" 7. OWASP ZAP (Baseline) Scan")
        print(f" 8. {B}RESULT FILE SCAN{C}")
        print(" 9. Exit")
        
        choice = input(f"{Y}\nOption: {C}")
        
        if choice == '9': break
        if choice == '8': view_results(); continue

        target = input(f"{Y}Target URL (http/https): {C}")
        if not target.startswith("http"):
            print(f"{R}Vui lòng nhập định dạng http:// hoặc https://{C}")
            continue

        if choice == '1':
            # Quét đa luồng cho Nmap, Nikto, Katana
            t1 = threading.Thread(target=nmap_scan, args=(target,))
            t2 = threading.Thread(target=nikto_scan, args=(target,))
            t3 = threading.Thread(target=katana_scan, args=(target,))
            t1.start(); t2.start(); t3.start()
            t1.join(); t2.join(); t3.join()
            # XSStrike và Wapiti chạy sau
            xsstrike_scan(target)
            wapiti_scan(target)
        elif choice == '2': nmap_scan(target)
        elif choice == '3': katana_scan(target)
        elif choice == '4': xsstrike_scan(target)
        elif choice == '5': nikto_scan(target)
elif choice == '6': wapiti_scan(target)
        elif choice == '7': zap_scan(target)
        else: print(f"{R}Invalid Option!{C}")

        input(f"\n{G}Nhấn Enter để tiếp tục...{C}")
        os.system('clear')

if __name__ == "__main__":
    # Khởi tạo log nếu chưa có
    if not os.path.exists(LOG_FILE):
        with open(LOG_FILE, "w", encoding="utf-8") as f: f.write("--- NEW SCAN ---\n")
    main_menu()
