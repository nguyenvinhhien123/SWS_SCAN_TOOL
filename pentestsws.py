import subprocess
import os
import datetime
import sys
import requests
import random
import shutil

# --- COLOR CONFIG ---
R = '\033[31m'; G = '\033[32m'; Y = '\033[33m'; B = '\033[34m'
W = '\033[37m'; C = '\033[0m' 

LOG_FILE = "sws_scan_result.log"
KATANA_FILE = "katana_urls.txt"
WAPITI_FILE = "wapiti_report.txt"
XSSTRIKE_PATH = "/home/kali/swit-scanner/apps/XSStrike/xsstrike.py"

PROXY_POOL = []
CURRENT_PROXY = ""

def banner():
    os.system('clear')
    print(f"{B}")
    print(r"    ███████╗██╗    ██╗███████╗")
    print(r"    ██╔════╝██║    ██║██╔════╝")
    print(r"    ███████╗██║ █╗ ██║███████╗")
    print(r"    ╚════██║██║███╗██║╚════██║")
    print(r"    ███████║╚███╔███╔╝███████║")
    print(r"    ╚══════╝ ╚══╝╚══╝ ╚══════╝")
    print(f"{Y} ╔" + "═"*60 + "╗")
    p_status = f"{G}ON ({CURRENT_PROXY}){C}" if CURRENT_PROXY else f"{R}OFF (DIRECT){C}"
    print(f" ║  LOVE FROM FPT University  ║ PROXY: {p_status}")
    print(f" ║  PROXIES LIST: {len(PROXY_POOL)} ║")
    print(f"{Y} ╚" + "═"*60 + "╝")

def write_log(content):
    with open(LOG_FILE, "a", encoding="utf-8") as f:
        f.write(content + "\n")

def export_and_read_log():
    if not os.path.exists(LOG_FILE) or os.stat(LOG_FILE).st_size == 0:
        print(f"{R}[!] No scan data to read.{C}")
        return

    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
    report_name = f"final_report_{timestamp}.log"
    
    try:
        shutil.copy(LOG_FILE, report_name)
        temp_files = [KATANA_FILE, WAPITI_FILE, "nikto_out.txt", "xsstrike_log.txt"]
        for f in temp_files:
            if os.path.exists(f): os.remove(f)

        print(f"{G}[✔] Export report: {report_name}{C}")
        input(f"{Y}[*] Press Enter to open report (Press 'q' to exit)...{C}")
        os.system(f"less -R {report_name}")
        open(LOG_FILE, "w").close()
    except Exception as e:
        print(f"{R}[!] Lỗi: {e}{C}")

def run_command(command, description):
    print(f"\n{G}[+] Running: {description}...{C}")
    write_log(f"\n{'='*30}\n{description.upper()}\nStart: {datetime.datetime.now()}\n{'='*30}")
    
    env = os.environ.copy()
    if CURRENT_PROXY:
        env["http_proxy"] = env["https_proxy"] = env["HTTP_PROXY"] = env["HTTPS_PROXY"] = CURRENT_PROXY
    
    try:
        process = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True, env=env)
        for line in process.stdout:
            print(line, end='')
            write_log(line.strip())
        process.wait()
    except Exception as e:
        print(f"{R}[!] Error: {e}{C}")

# --- TOOLS FUNC  ---

def nmap_scan(target):
    domain = target.replace("http://", "").replace("https://", "").split('/')[0]
    cmd = f"nmap -sV -Pn {domain}"
    if CURRENT_PROXY: 
        cmd += f" --proxies {CURRENT_PROXY}"
    run_command(cmd, "Nmap Scanning")

def xsstrike_scan(target):
    if os.path.exists(XSSTRIKE_PATH):
        cmd = f"python3 {XSSTRIKE_PATH} -u \"{target}\" --crawl --timeout 10"
        if CURRENT_PROXY: 
            cmd += " --proxy"
        run_command(cmd, "XSStrike Scan")
    else:
        print(f"{R}[!] XSStrike path not found!{C}")

def combined_vuln_scan(target):
    print(f"{Y}[*] Updating Nuclei templates...{C}")
    subprocess.run("nuclei -ut", shell=True, capture_output=True)
    
    cmd_n = f"nuclei -u {target} -severity low,medium,high,critical"
    if CURRENT_PROXY: 
        cmd_n += f" -proxy {CURRENT_PROXY}"
    run_command(cmd_n, "Nuclei Scan")
    
    cmd_w = f"wapiti -u {target} -f txt -o {WAPITI_FILE}"
    if CURRENT_PROXY: 
        cmd_w += f" -p {CURRENT_PROXY}"
    run_command(cmd_w, "Wapiti Scan")

# --- MENU  ---

def main_menu():
    global CURRENT_PROXY
    while True:
        banner()
        print(f" {W}1. Full Audit Scan {C}")
        print(f" {W}2. Nmap Scan{C}")
        print(f" {W}3. Web Crawl{C}")
        print(f" {W}4. Nikto Scan{C}")
        print(f" {W}5. XSS Scan{C}")
        print(f" {W}6. Web Vuln{C}")
        print(f" 8. {B}Report Log (Export & Read){C}")
        print(f" 9. {G}AUTO FETCH PROXY {C}")
        print(f" 10. {Y}LOAD PROXY FILE {C}")
        print(" 11. Exit")
        
        choice = input(f"{Y}\nOption: {C}")
        if choice == '11': break
        elif choice == '8': export_and_read_log(); continue
        elif choice == '9': 
            try:
                res = requests.get("https://api.proxyscrape.com/v2/?request=getproxies&protocol=http&timeout=5000", timeout=10)
                if res.status_code == 200:
                    proxy_list = res.text.strip().split('\r\n')
                    print(f"{Y}[*] Looking for alive proxy...{C}")
                    samples = random.sample(proxy_list, min(len(proxy_list), 20))
                    for p in samples:
                        p = p.strip()
                        if not p.startswith("http"): p = f"http://{p}"
                        try:
                            requests.get("http://www.google.com", proxies={"http": p, "https": p}, timeout=5)
                            CURRENT_PROXY = p
                            print(f"{G}[✔] Proxy Active: {p}{C}")
                            break
                        except: continue
            except: print(f"{R}[!] API ERROR.{C}")
            input("\nPress Enter..."); continue
        elif choice == '10':
            if os.path.exists("proxy.txt"):
                with open("proxy.txt", 'r') as f:
                    globals()['PROXY_POOL'] = [line.strip() for line in f if line.strip()]
                    print(f"{G}[✔] Upload proxies {len(PROXY_POOL)} successfully from file.{C}")
            else:
                print(f"{R}[!] proxy.txt not found!{C}")
            input("\nPress Enter..."); continue

        target = input(f"{Y}Target URL: {C}").strip()
        if not target.startswith("http"): 
            print(f"{R}[!] URL must start with http/https{C}")
            input("Press Enter...")
            continue

        if choice == '1':
            nmap_scan(target)
            run_command(f"katana -u {target}", "Katana Crawl")
            xsstrike_scan(target)
            combined_vuln_scan(target)
        elif choice == '2': nmap_scan(target)
        elif choice == '3': run_command(f"katana -u {target}", "Katana Crawl")
        elif choice == '4': run_command(f"nikto -h {target}", "Nikto Scan")
        elif choice == '5': xsstrike_scan(target)
        elif choice == '6': combined_vuln_scan(target)
        
        input(f"\n{G}Done Scanning. Press Enter to back to Menu...{C}")

if __name__ == "__main__":
    if not os.path.exists(LOG_FILE): 
        open(LOG_FILE, "w").close()
    main_menu()
